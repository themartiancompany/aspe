#!/usr/bin/env bash
#
# SPDX-License-Identifier: AGPL-3.0

set -e -u
shopt -s extglob

# Control the environment
umask 0022
export LC_ALL="C.UTF-8"
# LC_ALL=C.UTF-8, unlike LC_ALL=C, does not override LANGUAGE.
# See https://sourceware.org/bugzilla/show_bug.cgi?id=16621 \
# and https://savannah.gnu.org/bugs/?62815
[[ -v LANGUAGE ]] && \
  unset LANGUAGE
[[ -v SOURCE_DATE_EPOCH ]] || \
  printf -v SOURCE_DATE_EPOCH '%(%s)T' -1
export SOURCE_DATE_EPOCH


# Get source from a selected publisher
# $1: publisher (archlinux,
#                aur,
#                ur)
_git_repo() {
  local \
    _pub="${1}" \
    _pkg="${2}" \
    _http
  if [[ "${_pub}" == "archlinux" ]]; then
    _http='https://gitlab.archlinux.org'
    echo \
      "${_http}/${_pub}/packaging/packages/${_pkg}"
  fi
  if [[ "${_pub}" == "aur" ]]; then
    _http='https://aur.archlinux.org'
    echo \
      "${_http}/${_pkg}"
  fi
  if [[ "${_pub}" == "ur" ]]; then
    _http="http://github.com"
    _ns="themartiancompany"
    echo \
      "${_http}/${_ns}/${_pkg}-${_pub}"
  fi
}

_aspe() {
  local \
    _pub="${1}"
  shift 1
  local \
    _pkgs=() \
  _pkgs=(
    "$@")
  for \
    _pkg in \
      "${_pkgs[@]}"; do
    GIT_TERMINAL_PROMPT=0 \
      git \
        clone \
	  "$(_git_repo \
	       "${_pub}" \
	       "${_pkg}")"
    [[ ! "$?" -eq 0 ]] && \
      _pub="aur" && \
      git \
        clone \
          "$(_git_repo \
               "${_pub}" \
	       "${_pkg}")"
    [[ ! "$?" -eq 0 ]] && \
      _pub="ur" && \
      git \
        clone \
          "$(_git_repo \
               "${_pub}" \
	       "${_pkg}")"

  done
}

_usage() {
  echo \
    'Usage: aspe [pkgs]'
}

while getopts 'p:h?' arg; do
    case "${arg}" in
        p) override_pub="${OPTARG}" ;;
        h|?) _usage ;;
        *)
            _msg_error \
	      "Invalid argument '${arg}'" 0
            _usage
            ;;
    esac
done

shift $((OPTIND - 1))

_pkgs=(
  "$@")

[[ "${override_pub}" == "" ]] && \
  override_pub="archlinux"

if (( $# < 1 )); then
  _msg_error \
    "No packages specified"
  _usage
fi

_aspe \
  "${override_pub}" \
  "${_pkgs[@]}"
